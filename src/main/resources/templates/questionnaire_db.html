<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Questionnaire</title>
  <style>
    :root{--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;--accent:#2563eb;--accent-700:#1d4ed8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    h1{margin:0 0 12px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .q{padding:12px 0;border-bottom:1px solid var(--border)} .q:last-child{border-bottom:0}
    .q h3{margin:0 0 8px;font-size:1.05rem}
    .opt{display:flex;align-items:center;gap:10px;margin:6px 0}
    .opt input{accent-color:var(--accent)}
    textarea{width:100%;min-height:96px;border:1px solid var(--border);border-radius:12px;padding:10px}
    .actions{display:flex;gap:12px;margin-top:18px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:800;cursor:pointer;text-decoration:none}
    .btn:hover{background:var(--accent-700)}
    .muted{color:var(--muted)}
  </style>

  <script>
    // Pack MULTI selections into hidden inputs so the server receives "a,b,c".
    // Also clear the hidden value if nothing is selected.
    function packCheckboxes(){
      const byKey = {};
      document.querySelectorAll('input[name="__multi__"]').forEach(cb=>{
        const key = cb.getAttribute('data-key');
        (byKey[key] ||= []);
        if (cb.checked) byKey[key].push(cb.value);
      });

      // Update *all* hidden inputs for MULTI, even if no boxes are checked
      const prefix = 'hidden-';
      document.querySelectorAll(`input[type="hidden"][id^="${prefix}"]`).forEach(h=>{
        const key = h.id.substring(prefix.length);
        const arr = byKey[key] || [];
        h.value = arr.join(',');
      });

      return true;
    }
  </script>
</head>

<body>
<main class="wrap">
  <section class="card">
    <div class="row">
      <h1>Questionnaire</h1>
      <span class="muted">Language: <b th:text="${session.uiLang != null ? session.uiLang : 'en'}">en</b> (fixed)</span>
    </div>

    <form th:action="@{/questionnaire/submit}" th:object="${form}" method="post" onsubmit="return packCheckboxes()">
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

      <!-- Support both shapes: page.questions (current) or page.items (fallback) -->
      <div th:with="items=${page.questions != null ? page.questions : page.items}">

        <!-- Iterate and STRICTLY render only ipip.* or sjt.* questions -->
        <div th:each="q : ${items}" th:with="k=${q.key != null ? q.key : (q.qkey != null ? q.qkey : '')}">
          <div class="q"
               th:if="${k != null and (#strings.startsWith(k,'ipip.') or #strings.startsWith(k,'sjt.'))}"
               th:with="
                 text=${q.text != null && !#strings.isEmpty(q.text) ? q.text
                        : (q.label != null ? q.label : (q.key != null ? q.key : q.qkey))},
                 t=${q.type != null && !#strings.isEmpty(q.type) ? q.type
                        : ((q.options == null or #lists.isEmpty(q.options)) ? 'text' : 'single')}
               ">

            <!-- SINGLE -->
            <div th:if="${t == 'single'}">
              <h3 th:text="${text}">Question text</h3>
              <div th:each="o : ${q.options}" class="opt">
                <input type="radio"
                       th:id="${k + '-' + o.value}"
                       th:name="${'answers[' + k + ']'}"
                       th:value="${o.value}"
                       th:checked="${form != null && form.answers != null && form.answers[k] == o.value}" />
                <label th:for="${k + '-' + o.value}" th:text="${o.label}">Label</label>
              </div>
            </div>

            <!-- MULTI -->
            <div th:if="${t == 'multi'}">
              <h3 th:text="${text}">Question text</h3>
              <input type="hidden" th:id="${'hidden-' + k}" th:name="${'answers[' + k + ']'}"
                     th:value="${form != null && form.answers != null ? form.answers[k] : ''}" />
              <div th:each="o : ${q.options}" class="opt">
                <input type="checkbox"
                       name="__multi__"
                       th:id="${k + '-' + o.value}"
                       th:attr="data-key=${k}"
                       th:value="${o.value}"
                       th:checked="${form != null && form.answers != null && (',' + form.answers[k] + ',').contains(',' + o.value + ',')}" />
                <label th:for="${k + '-' + o.value}" th:text="${o.label}">Label</label>
              </div>
            </div>

            <!-- STRICT: no TEXT questions are rendered -->
          </div>
        </div>

        <div class="actions">
          <a class="btn"
             th:href="@{/questionnaire(page=${page.page-1}, pageSize=${page.pageSize})}"
             th:if="${page.page > 1}">Previous</a>

          <button class="btn" type="submit" th:if="${page.page == page.totalPages}">Submit</button>

          <a class="btn"
             th:href="@{/questionnaire(page=${page.page+1}, pageSize=${page.pageSize})}"
             th:if="${page.page < page.totalPages}">Next</a>

          <span class="muted" th:text="${'Page ' + page.page + ' of ' + page.totalPages}">Page 1 of 1</span>
        </div>
      </div>
    </form>
  </section>
</main>
</body>
</html>