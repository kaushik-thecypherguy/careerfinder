<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title th:text="${rec.title}">Result</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --accent-700:#1d4ed8; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1280px;margin:40px auto;padding:0 24px;display:grid;grid-template-columns:3fr 1.25fr;gap:24px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;box-shadow:0 1px 10px rgba(0,0,0,.05)}
    h1{margin:0 0 10px;font-size:1.8rem}
    h2{margin:18px 0 10px;font-size:1.2rem}
    p.lead{margin:0 0 14px;color:var(--muted)}
    .muted{color:var(--muted)}
    .small{font-size:.92rem}

    details.job{border:1px solid var(--border);border-radius:12px;padding:14px 14px;margin:12px 0;background:#fff}
    details.job[open]{box-shadow:0 4px 20px rgba(0,0,0,.06)}
    summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:14px}
    summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(90deg)}
    .s-title{font-weight:700}
    .s-fit{color:#475569;font-size:.92rem}
    .pill{margin-left:auto;display:inline-block;padding:4px 10px;border-radius:999px;font-size:.82rem}
    .pill.ok{background:#ecfdf5;color:#065f46}
    .pill.bad{background:#fef2f2;color:#991b1b}
    .val{min-width:52px;text-align:right;font-variant-numeric:tabular-nums;color:#334155}
    .rowline{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .block{margin-top:12px;border-top:1px dashed var(--border);padding-top:12px}

    .row{display:flex;align-items:center;gap:10px;margin:8px 0}
    .trait{flex:0 0 60%}
    .meter{flex:1;height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .fill{height:100%;background:var(--accent)}
    .valbar{width:52px;text-align:right;font-variant-numeric:tabular-nums;color:#334155}

    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:.85rem}
    a.link{color:var(--accent);font-weight:700;text-decoration:none}
    a.link:hover{color:var(--accent-700);text-decoration:underline}

    .rail details{margin:10px 0}
    .rail summary{font-weight:700;color:#1f2937}
    .rail .content{margin-top:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border)}
    th{text-align:left;color:#475569}
  </style>
</head>
<body>
<main class="wrap">

  <!-- CENTER: Top‑5 + Could‑have‑been -->
  <section class="card">
    <h1>Top 5 sectors (Eligible now)</h1>
    <p class="lead">These are your best fits based on your trait profile and current eligibility.</p>

    <div th:if="${topEligible != null && !#lists.isEmpty(topEligible)}">
      <details class="job" th:each="s : ${topEligible}"
               th:attr="data-sector-id=${s.id}, data-detail='full'">
        <summary>
          <span class="chev">▶</span>
          <div style="flex:1">
            <div class="s-title" th:text="${s.name}">Sector name</div>
            <div class="s-fit">Why fit:
              <span th:text="${#strings.listJoin(s.topContrib, ', ')}">Trait A, Trait B, Trait C</span>
            </div>
          </div>
          <div class="val" th:text="${#numbers.formatDecimal(s.score, 1, 1)}">0.0</div>
          <span class="pill ok">Eligible</span>
        </summary>

        <div class="block">
          <!-- advice container (no old placeholder text) -->
          <div class="advice" data-state="empty"></div>
        </div>
      </details>
    </div>

    <div th:if="${topEligible == null || #lists.isEmpty(topEligible)}" class="muted">
      No eligible sectors yet. Check “Could have been Top‑5” below for how to qualify.
    </div>

    <h2 style="margin-top:18px">Could have been Top‑5 if you were eligible</h2>

    <p class="small muted"
       th:if="${eligibleCutoff != null}"
       th:text="|Shown because score ≥ cutoff ${#numbers.formatDecimal(eligibleCutoff, 1, 1)}|">
      Shown because score ≥ cutoff 0.0
    </p>

    <div th:if="${nearMiss != null && !#lists.isEmpty(nearMiss)}">
      <details class="job" th:each="s : ${nearMiss}"
               th:attr="data-sector-id=${s.id}, data-detail='brief'">
        <summary>
          <span class="chev">▶</span>
          <div style="flex:1">
            <div class="s-title" th:text="${s.name}">Sector name</div>
            <div class="s-fit">Why fit:
              <span th:text="${#strings.listJoin(s.topContrib, ', ')}">Trait A, Trait B, Trait C</span>
            </div>
          </div>
          <div class="val" th:text="${#numbers.formatDecimal(s.score, 1, 1)}">0.0</div>
          <span class="pill bad">Not eligible</span>
        </summary>

        <div class="block" th:if="${s.reasons != null && !#lists.isEmpty(s.reasons)}">
          <div class="small" style="color:#991b1b;font-weight:700">What’s missing:</div>
          <ul class="small" style="margin:6px 0 0 18px;color:#475569">
            <li th:each="r : ${s.reasons}" th:text="${r}">Eligibility reason</li>
          </ul>
        </div>

        <div class="block">
          <!-- advice container for brief card too -->
          <div class="advice" data-state="empty"></div>
        </div>
      </details>
    </div>

    <div th:if="${nearMiss == null || #lists.isEmpty(nearMiss)}" class="muted">
      None for now — great! You’re eligible for your best matches already.
    </div>
  </section>

  <!-- RIGHT RAIL -->
  <aside class="card rail">
    <div class="badge">Profile & Answers</div>

    <details>
      <summary>Summary & Next steps</summary>
      <div class="content">
        <h2 style="margin:10px 0 6px" th:text="${rec.title}">Your result</h2>
        <p class="lead" th:text="${rec.summary}">Summary goes here</p>

        <h3 style="margin:12px 0 6px" th:text="${rec.careersTitle}">Suggested careers/trades</h3>
        <ul style="margin-top:6px">
          <li th:each="c : ${rec.suggestedCareers}">
            <a class="link" th:href="${c.href}" th:text="${c.label}" target="_blank" rel="noopener">Career</a>
          </li>
        </ul>

        <h3 style="margin:12px 0 6px" th:text="${rec.nextTitle}">Next steps</h3>
        <ul style="margin-top:6px">
          <li th:each="s : ${rec.nextSteps}" th:text="${s}">Step</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>Trait profile (0–100)</summary>
      <div class="content">
        <p class="small muted">Final = 60% IPIP + 40% SJT per trait.</p>
        <div th:each="e : ${profile.traitFinal0to100().entrySet()}">
          <div class="row">
            <div class="trait"
                 th:text="${T(com.acf.careerfinder.psychometrics.ScoringService).traitLabel(e.key)}">Trait name</div>
            <div class="meter"><div class="fill" th:style="${'width:' + e.value + '%'}"></div></div>
            <div class="valbar" th:text="${#numbers.formatDecimal(e.value, 1, 1)}">0.0</div>
          </div>
        </div>
      </div>
    </details>

    <details>
      <summary>Breakdown (IPIP vs SJT vs Final)</summary>
      <div class="content">
        <table>
          <thead>
          <tr><th>Trait</th><th>IPIP</th><th>SJT</th><th>Final</th></tr>
          </thead>
          <tbody>
          <tr th:each="e : ${profile.traitFinal0to100().entrySet()}">
            <td th:text="${T(com.acf.careerfinder.psychometrics.ScoringService).traitLabel(e.key)}">Trait</td>
            <td th:text="${#numbers.formatDecimal(profile.traitFromIpip0to100().get(e.key), 1, 1)}">0.0</td>
            <td th:text="${#numbers.formatDecimal(profile.traitSjt0to100().get(e.key), 1, 1)}">0.0</td>
            <td th:text="${#numbers.formatDecimal(e.value, 1, 1)}">0.0</td>
          </tr>
          </tbody>
        </table>
      </div>
    </details>

    <details>
      <summary>Domains (OCEAN)</summary>
      <div class="content">
        <div th:each="d : ${profile.ocean0to100().entrySet()}">
          <div class="row">
            <div class="trait"
                 th:text="${T(com.acf.careerfinder.psychometrics.ScoringService).domainLabel(d.key)}">Domain</div>
            <div class="meter"><div class="fill" th:style="${'width:' + d.value + '%'}"></div></div>
            <div class="valbar" th:text="${#numbers.formatDecimal(d.value, 1, 1)}">0.0</div>
          </div>
        </div>
      </div>
    </details>

    <details>
      <summary>Your answers</summary>
      <div class="content">
        <table>
          <tbody>
          <tr th:if="${rec.answersEcho != null && !#lists.isEmpty(rec.answersEcho)}"
              th:each="row : ${rec.answersEcho}">
            <th th:text="${row.label}">Question</th>
            <td th:text="${row.value}">Answer</td>
          </tr>

          <tr th:if="${(rec.answersEcho == null || #lists.isEmpty(rec.answersEcho))
                       and (rec.echoAnswers == null || #lists.isEmpty(rec.echoAnswers))}">
            <td colspan="2" class="muted">No answers found.</td>
          </tr>
          <tr th:if="${rec.answersEcho == null || #lists.isEmpty(rec.answersEcho)}"
              th:each="e : ${rec.echoAnswers}">
            <th th:text="${e.key}">Question</th>
            <td th:text="${e.value}">Answer</td>
          </tr>
          </tbody>
        </table>
      </div>
    </details>
  </aside>
</main>

<!-- Minimal inline JS: loads advice once per card -->
<script>
  (function(){
    function $(sel, root){ return (root||document).querySelector(sel); }
    function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

    function renderAdvice(container, data){
      const esc = s => (s ?? '').toString();
      const has = a => Array.isArray(a) && a.length > 0;

      const blocks = [];

      // Title line
      blocks.push(
        `<div class="small muted" style="margin-bottom:8px">
           <b>${esc(data.sectorName || '')}</b> – ${esc(data.userDistrict || '')}
           ${has(data.cityFocus) ? ` (focus: ${data.cityFocus.map(esc).join(', ')})` : ''}
         </div>`);

      if (has(data.whyFit)) {
        blocks.push(`<div><b>Why this fits:</b><ul style="margin:6px 0 0 18px">${data.whyFit.map(i=>`<li>${esc(i)}</li>`).join('')}</ul></div>`);
      }

      if (has(data.entryRoles)) {
        blocks.push(`<div style="margin-top:8px"><b>Entry roles nearby:</b><ul style="margin:6px 0 0 18px">${
          data.entryRoles.map(r=>`<li><b>${esc(r.title||'')}</b>${r.notes?` – ${esc(r.notes)}`:''}</li>`).join('')
        }</ul></div>`);
      }

      if (data.startingSalaryINR && (data.startingSalaryINR.district || (data.startingSalaryINR.nearby && data.startingSalaryINR.nearby.length))) {
        const s = data.startingSalaryINR;
        const nearby = Array.isArray(s.nearby) ? s.nearby.map(n=>`${esc(n.city)}: ${esc(n.range)}`).join('; ') : '';
        blocks.push(`<div style="margin-top:8px"><b>Starting salary (MH):</b> ${
          esc(s.district||'')
        }${nearby?` &nbsp;|&nbsp; ${nearby}`:''}${s.note?` &nbsp;<span class="small muted">(${esc(s.note)})</span>`:''}</div>`);
      }

      if (has(data.whereToApply)) {
        blocks.push(`<div style="margin-top:8px"><b>Where to apply:</b><ul style="margin:6px 0 0 18px">${
          data.whereToApply.map(l=>`<li><a class="link" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a></li>`).join('')
        }</ul></div>`);
      }

      if (data.nearbyIfSparse && (data.nearbyIfSparse.explanation || has(data.nearbyIfSparse.suggestedCities))) {
        blocks.push(`<div style="margin-top:8px"><b>If few roles locally:</b> ${
          esc(data.nearbyIfSparse.explanation || '')
        } ${has(data.nearbyIfSparse.suggestedCities)?' — ' + data.nearbyIfSparse.suggestedCities.map(esc).join(', '):''}</div>`);
      }

      if (has(data.gatingReminders)) {
        blocks.push(`<div style="margin-top:8px"><b>Keep in mind:</b><ul style="margin:6px 0 0 18px">${
          data.gatingReminders.map(i=>`<li>${esc(i)}</li>`).join('')
        }</ul></div>`);
      }

      if (has(data.checklistWeek1)) {
        blocks.push(`<div style="margin-top:8px"><b>This week:</b><ul style="margin:6px 0 0 18px">${
          data.checklistWeek1.map(i=>`<li>${esc(i)}</li>`).join('')
        }</ul></div>`);
      }

      if (has(data.disclaimers)) {
        blocks.push(`<div class="small muted" style="margin-top:8px">${data.disclaimers.map(esc).join(' ')}</div>`);
      }

      container.innerHTML = blocks.join('');
      container.setAttribute('data-state','loaded');
    }

    function loadAdviceOnce(detailsEl){
      const container = detailsEl.querySelector('.advice');
      if (!container || container.getAttribute('data-state') === 'loaded') return;

      const sectorId = detailsEl.getAttribute('data-sector-id');
      const detail = detailsEl.getAttribute('data-detail') || 'full';
      if (!sectorId) return;

      container.innerHTML = `<div class="small muted">Loading…</div>`;
      fetch(`/api/sector-advice?sectorId=${encodeURIComponent(sectorId)}&detail=${encodeURIComponent(detail)}`, {
        headers: { "Accept":"application/json" }
      })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(json => renderAdvice(container, json))
        .catch(() => {
          container.innerHTML = `<div class="small muted">Couldn’t load advice. Please try again.</div>`;
        });
    }

    // Attach to all job <details>
    $all('details.job').forEach(d => {
      d.addEventListener('toggle', () => {
        if (d.open) loadAdviceOnce(d);
      }, { passive:true });
    });
  })();
</script>
</body>
</html>